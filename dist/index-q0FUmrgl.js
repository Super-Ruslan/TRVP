var b=Object.defineProperty;var _=(c,t,e)=>t in c?b(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var u=(c,t,e)=>(_(c,typeof t!="symbol"?t+"":t,e),e),T=(c,t,e)=>{if(!t.has(c))throw TypeError("Cannot "+e)};var a=(c,t,e)=>(T(c,t,"read from private field"),e?e.call(c):t.get(c)),g=(c,t,e)=>{if(t.has(c))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(c):t.set(c,e)},h=(c,t,e,s)=>(T(c,t,"write to private field"),s?s.call(c,e):t.set(c,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();var k,y,f,D;class L{constructor({routeStopID:t=null,text:e,stops:s,position:o,onDeleteTask:n}){g(this,k,"");g(this,y,"");g(this,f,"");g(this,D,-1);h(this,k,t||crypto.randomUUID()),h(this,y,e),h(this,f,s[a(this,y)].name),h(this,D,o),this.onDeleteTask=n}get taskID(){return a(this,k)}get taskText(){return a(this,y)}set taskText(t){typeof t=="string"&&h(this,y,t)}get stopName(){return a(this,f)}set stopName(t){typeof t=="string"&&h(this,f,t)}get routeStopPosition(){return a(this,D)}set routeStopPosition(t){typeof t=="number"&&t>=0&&h(this,D,t)}render(){const t=document.createElement("li");t.classList.add("tasklist__tasks-list-item","task"),t.setAttribute("id",a(this,k)),t.setAttribute("draggable",!0),t.addEventListener("dragstart",i=>{i.target.classList.add("task_selected"),localStorage.setItem("movedTaskID",a(this,k))}),t.addEventListener("dragend",i=>i.target.classList.remove("task_selected"));const e=document.createElement("span");e.classList.add("task__text"),e.innerHTML=`Ост. ${a(this,f)}`,t.appendChild(e);const s=document.createElement("div");s.classList.add("task__controls");const o=document.createElement("div");o.classList.add("task__controls-row");const n=document.createElement("button");n.setAttribute("type","button"),n.classList.add("task__contol-btn","edit-icon"),n.addEventListener("click",()=>{localStorage.setItem("selectOtherStopRouteStopID",a(this,k)),document.getElementById("modal-select-other-stop").showModal()}),o.appendChild(n);const r=document.createElement("button");return r.setAttribute("type","button"),r.classList.add("task__contol-btn","delete-icon"),r.addEventListener("click",()=>this.onDeleteTask({taskID:a(this,k)})),o.appendChild(r),s.appendChild(o),t.appendChild(s),t}}k=new WeakMap,y=new WeakMap,f=new WeakMap,D=new WeakMap;class p{static async getStops(){try{const t=await fetch("http://localhost:4321/stops"),e=await t.json();return t.status!==200?Promise.reject(e):e}catch(t){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:t.message})}}static async getRoutes(){try{const t=await fetch("http://localhost:4321/routes"),e=await t.json();return t.status!==200?Promise.reject(e):e.routes}catch(t){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:t.message})}}static async addRoute({routeID:t,number:e=-1,position:s=-1}={routeID:null,number:-1,position:-1}){try{const o=await fetch("http://localhost:4321/routes",{method:"POST",body:JSON.stringify({routeID:t,number:e,position:s}),headers:{"Content-Type":"application/json"}});if(o.status!==200){const n=await o.json();return Promise.reject(n)}return{timestamp:new Date().toISOString(),message:`Маршрут '${e}' добавлен`}}catch(o){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:o.message})}}static async deleteRoute({routeID:t}={routeID:null}){try{const e=await fetch(`http://localhost:4321/routes/${t}`,{method:"DELETE"});if(e.status!==200){const s=await e.json();return Promise.reject(s)}return{timestamp:new Date().toISOString(),message:`Маршрут с id ${t} удален`}}catch(e){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:e.message})}}static async updateRoute({routeID:t,number:e=-1}={routeID:null,number:-1}){try{const s=await fetch(`http://localhost:4321/routes/${t}`,{method:"PATCH",body:JSON.stringify({number:e}),headers:{"Content-Type":"application/json"}});if(s.status!==200){const o=await s.json();return Promise.reject(o)}return{timestamp:new Date().toISOString(),message:`Маршрут '${e}' обновлен`}}catch(s){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:s.message})}}static async addRouteStop({routeStopID:t,routeID:e,stopID:s,position:o=-1}={routeStopID:null,routeID:null,stopID:null,position:-1}){try{const n=await fetch("http://localhost:4321/route-stops",{method:"POST",body:JSON.stringify({routeStopID:t,routeID:e,stopID:s,position:o}),headers:{"Content-Type":"application/json"}});if(n.status!==200){const r=await n.json();return Promise.reject(r)}return{timestamp:new Date().toISOString(),message:`Остановка с id '${s}' добавлена в маршрут`}}catch(n){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:n.message})}}static async deleteRouteStop({routeStopID:t}={routeStopID:null}){try{const e=await fetch(`http://localhost:4321/route-stops/${t}`,{method:"DELETE"});if(e.status!==200){const s=await e.json();return Promise.reject(s)}return{timestamp:new Date().toISOString(),message:`Остановка маршрута с id ${t} удалена`}}catch(e){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:e.message})}}static async updateRouteStop({routeStopID:t,stopID:e,position:s}={routeStopID:null,stopID:null,number:-1}){try{const o=await fetch(`http://localhost:4321/route-stops/${t}`,{method:"PATCH",body:JSON.stringify({stopID:e,position:s}),headers:{"Content-Type":"application/json"}});if(o.status!==200){const n=await o.json();return Promise.reject(n)}return{timestamp:new Date().toISOString(),message:`Остановка с id '${e}' обновлена`}}catch(o){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:o.message})}}static async updateRouteStops({reorderedRouteStops:t=[]}={reorderedRouteStops:[]}){try{const e=await fetch("http://localhost:4321/routes",{method:"PATCH",body:JSON.stringify({reorderedRouteStops:t}),headers:{"Content-Type":"application/json"}});if(e.status!==200){const s=await e.json();return Promise.reject(s)}return{timestamp:new Date().toISOString(),message:"Порядок остановок в маршруте обновлен"}}catch(e){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:e.message})}}static async moveRouteStop({routeStopID:t,routeID:e}={routeStopID:null,routeID:null}){try{const s=await fetch("http://localhost:4321/route-stops",{method:"PATCH",body:JSON.stringify({routeStopID:t,routeID:e}),headers:{"Content-Type":"application/json"}});if(s.status!==200){const o=await s.json();return Promise.reject(o)}return{timestamp:new Date().toISOString(),message:`Остановка маршрута с id ${t} перемещена`}}catch(s){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:s.message})}}}var S,I,m,R;class E{constructor({routeID:t=null,name:e,position:s,onDropTaskInTasklist:o,onDeleteTask:n,onDeleteRoute:r,onEditRoute:i}){g(this,S,[]);g(this,I,-1);g(this,m,null);g(this,R,-1);u(this,"addTask",({task:t})=>a(this,S).push(t));u(this,"getTaskById",({taskID:t})=>a(this,S).find(e=>e.taskID===t));u(this,"deleteTask",({taskID:t})=>{const e=a(this,S).findIndex(o=>o.taskID===t);if(e===-1)return;const[s]=a(this,S).splice(e,1);return s});u(this,"reorderTasks",async()=>{const t=Array.from(document.querySelector(`[id="${a(this,m)}"] .tasklist__tasks-list`).children,s=>s.getAttribute("id")),e=[];if(t.forEach((s,o)=>{const n=a(this,S).find(r=>r.taskID===s);n.routeStopPosition!==o&&(n.routeStopPosition=o,e.push({routeStopID:s,position:o}))}),e.length>0)try{await p.updateRouteStops({reorderedRouteStops:e})}catch(s){console.error(s)}});u(this,"addNewStop",async({stopID:t})=>{try{const e=crypto.randomUUID(),s=await p.addRouteStop({routeStopID:e,routeID:a(this,m),stopID:t,position:a(this,S).length}),o=await p.getStops();this.addNewRouteStopLocal({stopID:t,stops:o,position:a(this,S).length}),console.log(s)}catch(e){console.error(e)}});u(this,"addNewRouteStopLocal",({routeStopID:t=null,stopID:e,stops:s,position:o})=>{const n=new L({routeStopID:t,text:e,stops:s,position:o,onDeleteTask:this.onDeleteTask});a(this,S).push(n);const r=n.render();document.querySelector(`[id="${a(this,m)}"] .tasklist__tasks-list`).appendChild(r)});h(this,I,e),h(this,m,t||crypto.randomUUID()),h(this,R,s),this.onDropTaskInTasklist=o,this.onDeleteTask=n,this.onDeleteRoute=r,this.onEditRoute=i}get tasklistID(){return a(this,m)}get routePosition(){return a(this,R)}get routeNumber(){return a(this,I)}set routeNumber(t){typeof t=="number"&&t>=0&&h(this,I,t)}render(){const t=document.createElement("li");t.classList.add("tasklists-list__item","tasklist"),t.setAttribute("id",a(this,m)),t.addEventListener("dragstart",()=>localStorage.setItem("srcTasklistID",a(this,m))),t.addEventListener("drop",this.onDropTaskInTasklist);const e=document.createElement("h2");e.classList.add("tasklist__name"),e.innerHTML=`Маршрут №${a(this,I)}`,e.addEventListener("click",()=>this.onEditRoute({routeID:a(this,m)})),t.appendChild(e);const s=document.createElement("ul");s.classList.add("tasklist__tasks-list"),t.appendChild(s);const o=document.createElement("button");o.setAttribute("type","button"),o.classList.add("tasklist__add-task-btn"),o.innerHTML="&#10010; Добавить остановку",o.addEventListener("click",()=>{localStorage.setItem("selectStopRouteID",a(this,m)),document.getElementById("modal-select-stop").showModal()}),t.appendChild(o);const n=document.createElement("button");n.setAttribute("type","button"),n.classList.add("tasklist__delete-route-btn"),n.innerHTML="&#10060; Удалить маршрут",n.addEventListener("click",()=>this.onDeleteRoute({routeID:a(this,m)})),t.appendChild(n);const r=document.querySelector(".tasklist-adder");r.parentElement.insertBefore(t,r)}}S=new WeakMap,I=new WeakMap,m=new WeakMap,R=new WeakMap;var l;class P{constructor(){g(this,l,[]);u(this,"checkRouteStops",(t,e)=>{const s=t.routeStops;s.sort((n,r)=>n.routeStopPosition-r.routeStopPosition);function o(n){for(let r=n+1;r<s.length;r++)if(s[n].stopID===s[r].stopID)return r;return-1}for(let n=0;n<s.length-1;n++){const r=s[n].stopID,i=s[n+1].stopID;if(e[r].connected_with.findIndex(w=>w===i)===-1)return!1;const d=o(n);if(n===0&&d!==-1&&d!==s.length-1)return!1;if(n!==0&&d!==-1)return!1}return!0});u(this,"checkRoutes",async()=>{const t=[],[e,s]=await Promise.all([p.getRoutes(),p.getStops()]);for(const o of e)this.checkRouteStops(o,s)||t.push(o.routeNumber);return t});u(this,"onEscapeKeydown",t=>{if(t.key==="Escape"){const e=document.querySelector(".tasklist-adder__input");e.style.display="none",e.value="",document.querySelector(".tasklist-adder__btn").style.display="inherit"}});u(this,"onInputKeydown",async t=>{if(t.key!=="Enter")return;const e=Number(t.target.value);if(!Number.isInteger(e)||e<=1){alert("Номера маршрутов задаются положительными целочисленными цифрами");return}if(t.target.value){const s=crypto.randomUUID();let o=0;a(this,l).length>0&&(o=a(this,l)[a(this,l).length-1].routePosition+1);try{const n=await p.addRoute({routeID:s,number:e,position:o}),r=new E({routeID:s,name:t.target.value,position:o,onDropTaskInTasklist:this.onDropTaskInTasklist,onDeleteTask:this.onDeleteTask,onDeleteRoute:this.onDeleteRoute,onEditRoute:this.onEditRoute});a(this,l).push(r),r.render(),console.log(n)}catch(n){console.error(n)}}t.target.style.display="none",t.target.value="",document.querySelector(".tasklist-adder__btn").style.display="inherit"});u(this,"onDropTaskInTasklist",async t=>{t.stopPropagation();const e=t.currentTarget;e.classList.remove("tasklist_droppable");const s=localStorage.getItem("movedTaskID"),o=localStorage.getItem("srcTasklistID"),n=e.getAttribute("id");if(localStorage.setItem("movedTaskID",""),localStorage.setItem("srcTasklistID",""),!e.querySelector(`[id="${s}"]`))return;const r=a(this,l).find(d=>d.tasklistID===o),i=a(this,l).find(d=>d.tasklistID===n);try{if(await p.moveRouteStop({routeStopID:s,routeID:n}),o!==n){const w=r.deleteTask({taskID:s});i.addTask({task:w}),await r.reorderTasks(),console.log(`Остановка маршрута с id ${s} перемещена`)}await i.reorderTasks();const d=await this.checkRoutes();d.length>0&&alert(`Некорректные маршруты ${d}`)}catch(d){console.error(d)}});u(this,"onEditRoute",async({routeID:t})=>{let e=a(this,l).find(n=>n.tasklistID==t);const s=prompt("Введите новый номер маршрута",e.routeNumber);if(!s)return;const o=Number(s);if(!Number.isInteger(o)||o<=0){alert("Номера маршрутов задаются положительными целочисленными цифрами");return}if(o!==e.routeNumber)try{const n=await p.updateRoute({routeID:t,number:o}),r=a(this,l).findIndex(i=>i.tasklistID===t);if(r===-1)return;a(this,l).splice(r,1),document.getElementById(t).querySelector(".tasklist__name").innerText=`Маршрут №${o}`,console.log(n)}catch(n){console.error(n)}});u(this,"editTask",async({taskID:t,newStopID:e})=>{let s=null;for(let n of a(this,l))if(s=n.getTaskById({taskID:t}),s)break;const o=s.taskText;if(!(!e||e===o))try{const n=p.updateRouteStop({routeStopID:t,stopID:e}),i=(await p.getStops())[e].name;s.taskText=e,s.stopName=i,document.querySelector(`[id="${t}"] span.task__text`).innerHTML=`Ост. ${i}`,console.log(n);const d=await this.checkRoutes();d.length>0&&alert(`Некорректные маршруты ${d}`)}catch(n){console.log(n)}});u(this,"onDeleteRoute",async({routeID:t})=>{if(a(this,l).find(s=>s.tasklistID==t),!!confirm("Маршрут будет удален. Прододлжить?"))try{const s=await p.deleteRoute({routeID:t}),o=a(this,l).findIndex(n=>n.tasklistID===t);if(o===-1)return;a(this,l).splice(o,1),document.getElementById(t).remove(),console.log(s)}catch(s){console.error(s)}});u(this,"onDeleteTask",async({taskID:t})=>{let e=null,s=null;for(let n of a(this,l))if(s=n,e=n.getTaskById({taskID:t}),e)break;if(confirm("Остановка будет удалена из маршрута. Прододлжить?"))try{const n=await p.deleteRouteStop({routeStopID:t});s.deleteTask({taskID:t}),document.getElementById(t).remove(),console.log(n);const r=await this.checkRoutes();r.length>0&&alert(`Некорректные маршруты ${r}`)}catch(n){console.error(n)}})}initSelectStopModal(t){const e=document.querySelector("#modal-select-stop"),s=e.querySelector(".app-modal__select");for(const r in t){const i=document.createElement("option");i.setAttribute("value",r),i.classList.add("select-option"),i.innerText=t[r].name,s.appendChild(i)}const o=()=>{e.close(),localStorage.setItem("selectStopRouteID","")},n=async()=>{const r=localStorage.getItem("selectStopRouteID");r&&a(this,l).find(d=>d.tasklistID===r).addNewStop({stopID:s.value}),o();const i=await this.checkRoutes();i.length>0&&alert(`Некорректные маршруты ${i}`)};e.querySelector(".modal-ok-btn").addEventListener("click",n),e.querySelector(".modal-cancel-btn").addEventListener("click",o),e.addEventListener("close",o)}initSelectOtherStopModal(t){const e=document.querySelector("#modal-select-other-stop"),s=e.querySelector(".app-modal__select");for(const r in t){const i=document.createElement("option");i.setAttribute("value",r),i.classList.add("select-option"),i.innerText=t[r].name,s.appendChild(i)}const o=()=>{e.close(),localStorage.setItem("selectOtherStopRouteStopID","")},n=()=>{const r=localStorage.getItem("selectOtherStopRouteStopID");r&&this.editTask({taskID:r,newStopID:s.value}),o()};e.querySelector(".modal-ok-btn").addEventListener("click",n),e.querySelector(".modal-cancel-btn").addEventListener("click",o),e.addEventListener("close",o)}async init(){document.querySelector(".tasklist-adder__btn").addEventListener("click",t=>{t.target.style.display="none";const e=document.querySelector(".tasklist-adder__input");e.style.display="inherit",e.focus()}),document.addEventListener("keydown",this.onEscapeKeydown),document.querySelector(".tasklist-adder__input").addEventListener("keydown",this.onInputKeydown),document.getElementById("theme-switch").addEventListener("change",t=>{t.target.checked?document.body.classList.add("dark-theme"):document.body.classList.remove("dark-theme")}),document.addEventListener("dragover",t=>{t.preventDefault();const e=document.querySelector(".task.task_selected"),s=e.closest(".tasklist"),o=t.target,n=document.querySelector(".tasklist_droppable");let r=t.target;for(;!r.matches(".tasklist")&&r!==document.body;)r=r.parentElement;if(r!==n&&(n&&n.classList.remove("tasklist_droppable"),r.matches(".tasklist")&&r.classList.add("tasklist_droppable")),!(!r.matches(".tasklist")||e===o)){if(r===s){if(!o.matches(".task"))return;const i=o===e.nextElementSibling?o.nextElementSibling:o;r.querySelector(".tasklist__tasks-list").insertBefore(e,i);return}if(o.matches(".task")){r.querySelector(".tasklist__tasks-list").insertBefore(e,o);return}r.querySelector(".tasklist__tasks-list").children.length||r.querySelector(".tasklist__tasks-list").appendChild(e)}});try{const t=await p.getRoutes(),e=await p.getStops();this.initSelectStopModal(e),this.initSelectOtherStopModal(e);for(const s of t){console.log(s),console.log(this.checkRouteStops(s,e)),this.checkRouteStops(s,e);const o=new E({routeID:s.routeID,name:s.routeNumber,position:s.routePosition,onDropTaskInTasklist:this.onDropTaskInTasklist,onDeleteTask:this.onDeleteTask,onDeleteRoute:this.onDeleteRoute,onEditRoute:this.onEditRoute});a(this,l).push(o),o.render();for(const n of s.routeStops)o.addNewRouteStopLocal({routeStopID:n.routeStopID,stopID:n.stopID,stops:e,position:n.routeStopPosition})}}catch(t){console.error(t)}}}l=new WeakMap;document.addEventListener("DOMContentLoaded",()=>{new P().init()});
